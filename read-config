#!/bin/zsh
#─────────────────────────────────────────────────────────────────
# Translate values in a config section in zsh parameters
#
# author:  Ludovic Vigouroux <ludo@mundoludo.fr>
# created: 2013-01-13
#─────────────────────────────────────────────────────────────────

usage () {
	print "read-config section config_file"
	exit
}

# some checks
[[ $# -lt 2 ]] && usage
config=$*[$#]
[[ ! -e $config ]] &&\
	print -- "config file \"$2\" not found" &&\
	exit 1
for section in $*[1,(($# - 1))]; do

  ! grep -qE '^\[ ?'$section $config &&\
  	print -- "section \"$section\" not found" &&\
  	exit 1

  # retrieve array type of section
  simple=$(awk '/^\[/ {p=0}; /^[a-zA-Z]*=.*,/ && p {print "true"; p=0} /^\[ ?'$section'/ {p=1};' $config)
  # translate config
  # simple array
  if [[ -n $simple ]]; then
  	awk -F = '/^\[/ {p=0};/^[a-zA-Z]/ && p {gsub(","," "); print $1"=("$2")"}; /^\[ ?'$section'/ {p=1};' $config
  # associative array
  else
  	echo "typeset -A "$section
  	awk -F = '/^\[/ {p=0}; /^[a-zA-Z]/ && p {print "'$section'["$1"]="$2}; /^\[ ?'$section'/ {p=1};' $config
  fi

done

# vim: set filetype=zsh:
