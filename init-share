#!/bin/zsh
#─────────────────────────────────────────────────────────────────
# Initialize a new share
#
# usage:   init-share [config file]
#
# author:  Ludovic Vigouroux <ludo@mundoludo.fr>
# created: December 2011
#─────────────────────────────────────────────────────────────────

# retrieve this file location
pushd "$(dirname ${0})"
script_location=$(pwd)
popd

# load functions
autoload -U colors; colors
. $script_location/lib/check-system && check-system
. $script_location/lib/translate-config
. $script_location/lib/clean-config-path

# options
[[ -z $quiet ]] && quiet=false

# load config
conf=$2
clean-config-path $conf

#─────────────────────────────────────────────────────────────────
# Create group if needed
#─────────────────────────────────────────────────────────────────
create_group () {
    if $DARWIN; then
    	if dscl . list /groups | grep -q $groupname ; then
    		$quiet || print -- "share group: $fg[blue]${groupname}$fg[default]"
    	else
    		$quiet || print -- "Creating share group\
    			$fg[blue]${groupname}$fg[default]"
    		dscl . create /groups/$groupname gid $groupid
    	fi
    else # linux
    	#todo add getenv
    	groupadd --gid $groupid $groupname
    fi
}

#─────────────────────────────────────────────────────────────────
# Create share if needed
#─────────────────────────────────────────────────────────────────
create_share () {
    # Create share if needed
    if [[ -d $share ]]; then
    	$quiet || print -- "share location: $fg[blue]${share}$fg[default]."
    else
    	$quiet || print -- "Creating new directory $fg[blue]$share$fg[default]."
    	mkdir -p $share || exit 1
    fi
}

#─────────────────────────────────────────────────────────────────
# Set permissions on local share
#─────────────────────────────────────────────────────────────────
set_permissions () {
    chgrp $groupname $share
    chmod 2775 $share
    $quiet || print -- "permission on share:${fg[blue]}"\
    	$(stat -c "%n are %A owner=%U(%u) group=%G(%g)" $share)\
    	$fg_no_bold[default]
}

#─────────────────────────────────────────────────────────────────
# Install new share with values from config
#─────────────────────────────────────────────────────────────────
install_share () {
	# Parse share config file section
	confsection=share
	trconfig='{print $1"="$2}'

	# retrieve share configuration
	translate_config $confsection $trconfig $conf

	# clean share values
	share=$share_location
	groupname=$group_name
	groupid=$group_id

	create_group
	create_share
	set_permissions
}

#─────────────────────────────────────────────────────────────────
# Main
#─────────────────────────────────────────────────────────────────
# Create shared directory with group and permissions accordingly 
# to a config file

$quiet || print $fg[green]"Shared directory"$fg[default]
install_share

## vim: set filetype=zsh:
